<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°ì´í„° ë°±ì—… & ë³µêµ¬</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 14px; }
        .backup-btn { background: #28a745; color: white; border: none; }
        .restore-btn { background: #dc3545; color: white; border: none; }
        .download-btn { background: #007bff; color: white; border: none; }
        button:hover { opacity: 0.8; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ë°ì´í„° ë°±ì—… & ë³µêµ¬ ì‹œìŠ¤í…œ</h1>
    
    <div class="section">
        <h2>ğŸ“¦ ë°±ì—… ìƒì„±</h2>
        <button class="backup-btn" onclick="createBackup()">í˜„ì¬ ë°ì´í„° ë°±ì—…</button>
        <button class="download-btn" onclick="downloadBackup()">ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
        <div id="backup-status"></div>
    </div>

    <div class="section">
        <h2>ğŸ”„ ë°±ì—… ë³µêµ¬</h2>
        <input type="file" id="restore-file" accept=".json">
        <button class="restore-btn" onclick="restoreBackup()">ë°±ì—… ë³µêµ¬</button>
        <div id="restore-status"></div>
    </div>

    <div class="section">
        <h2>ğŸ“Š ë°±ì—… ë‚´ì—­</h2>
        <div id="backup-list"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQmDCL-PuN2A9AgOzIpObCeNtvIFDJmhU",
            authDomain: "studio-8412089884-f8185.firebaseapp.com",
            projectId: "studio-8412089884-f8185",
            storageBucket: "studio-8412089884-f8185.firebasestorage.app",
            messagingSenderId: "928283224778",
            appId: "1:928283224778:web:01cb08827402140aace233"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentBackup = null;

        window.createBackup = async function() {
            const status = document.getElementById('backup-status');
            status.innerHTML = '<div class="status info">ë°±ì—… ìƒì„± ì¤‘...</div>';
            
            try {
                const snapshot = await getDocs(collection(db, "curriculum_events"));
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                
                currentBackup = {
                    timestamp: new Date().toISOString(),
                    count: data.length,
                    data: data
                };
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                localStorage.setItem('curriculum_backup', JSON.stringify(currentBackup));
                
                status.innerHTML = `<div class="status success">
                    âœ… ë°±ì—… ì™„ë£Œ!<br>
                    ì‹œê°„: ${new Date(currentBackup.timestamp).toLocaleString('ko-KR')}<br>
                    ì¼ì • ìˆ˜: ${currentBackup.count}ê°œ
                </div>`;
                
                loadBackupList();
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ ë°±ì—… ì‹¤íŒ¨: ${error.message}</div>`;
            }
        };

        window.downloadBackup = function() {
            const backup = localStorage.getItem('curriculum_backup');
            if (!backup) {
                alert('ë°±ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°±ì—…ì„ ìƒì„±í•˜ì„¸ìš”.');
                return;
            }
            
            const blob = new Blob([backup], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `curriculum_backup_${new Date().toISOString().replace(/:/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.restoreBackup = async function() {
            const fileInput = document.getElementById('restore-file');
            const status = document.getElementById('restore-status');
            
            if (!fileInput.files[0]) {
                status.innerHTML = '<div class="status error">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
                return;
            }
            
            if (!confirm('âš ï¸ ê²½ê³ : í˜„ì¬ ë°ì´í„°ê°€ ë°±ì—… ë°ì´í„°ë¡œ ì™„ì „íˆ ëŒ€ì²´ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            status.innerHTML = '<div class="status info">ë³µêµ¬ ì¤‘...</div>';
            
            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const backup = JSON.parse(text);
                
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                const snapshot = await getDocs(collection(db, "curriculum_events"));
                for (const docSnap of snapshot.docs) {
                    await deleteDoc(doc(db, "curriculum_events", docSnap.id));
                }
                
                // ë°±ì—… ë°ì´í„° ë³µêµ¬
                for (const item of backup.data) {
                    const { id, ...data } = item;
                    await setDoc(doc(db, "curriculum_events", id), data);
                }
                
                status.innerHTML = `<div class="status success">
                    âœ… ë³µêµ¬ ì™„ë£Œ!<br>
                    ë³µêµ¬ëœ ì¼ì •: ${backup.count}ê°œ<br>
                    ë°±ì—… ì‹œê°„: ${new Date(backup.timestamp).toLocaleString('ko-KR')}
                </div>`;
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ ë³µêµ¬ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        };

        function loadBackupList() {
            const backup = localStorage.getItem('curriculum_backup');
            const list = document.getElementById('backup-list');
            
            if (!backup) {
                list.innerHTML = '<p>ì €ì¥ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const data = JSON.parse(backup);
            list.innerHTML = `
                <div class="status info">
                    <strong>ìµœê·¼ ë°±ì—…:</strong><br>
                    ì‹œê°„: ${new Date(data.timestamp).toLocaleString('ko-KR')}<br>
                    ì¼ì • ìˆ˜: ${data.count}ê°œ
                </div>
            `;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°±ì—… ëª©ë¡ í‘œì‹œ
        loadBackupList();
    </script>
</body>
</html>
